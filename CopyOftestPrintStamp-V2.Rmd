---
title: "Registre du Timbre Fédéral de négociation"
classoption: landscape
# header-includes: 
#     \usepackage{fancyhdr}
#     \pagestyle{fancy}
#     \lhead{"Artha"}
#     \rhead{"IB"}
                
output: pdf_document
geometry: margin=0.7cm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

Artha Finance Suisse SA
\hspace{519pt}
Interactive Brokers UK Ltd  


\begin{flushright}
`r format(Sys.Date(), "%e %B %Y")`
\end{flushright}


```{r analysys, echo= FALSE, include= FALSE}

library(data.table)

load("TF.RData")
#setkey(TF, OrderTime, Description)
setorder(TF, OrderTime, Description, -ClientId)

TF[, Dom:= ifelse(grepl("Interactive", ClientId), "ETR", "CH")]
TF[, opNbr:= .GRP, by=c("OrderTime", "Description")] 
#TF[, Grp:= opNbr %/% 17 +1]

TF[, Grp:= c(cliNbr[1], rep(0,.N - 1L)), by= opNbr]
TF[, Grp:= cumsum(Grp) %/% 40 + 1]

#TF[, .N, by=Grp]


TF <- TF[, c("Grp", "opNbr", "TradeDate", "Buy.Sell", "Quantity",
             "Description", "ISIN", "TradePrice", "Currency", "Fx",
             "ClientId", "Dom", "SoumisSuisse", "SoumisEtr", "NonSoumis")]


tot <- TF[, lapply(.SD, sum), by= "Grp",
          .SDcols= c("SoumisSuisse", "SoumisEtr",
                     "NonSoumis")]

#tot[, ':=' (opNbr=NA, TradeDate= NA, Buy.Sell ="", Quantity= NA,
#           Description= "", ISIN="", TradePrice=NA, Currency= "", Fx=NA,
#           ClientId= "Contre valeur totale", Dom="")]

droits <- tot[, .(SoumisSuisse * 0.075 / 100,
                  SoumisEtr * 0.15 / 100,
                  0), by= "Grp"]

#droits[, ':=' (opNbr=NA, TradeDate= NA, Buy.Sell ="", Quantity= NA,
#           Description= "", ISIN="", TradePrice=NA, Currency= "", Fx=NA,
#           ClientId= "Droits négociation dus", Dom="")]

colnames(droits) <- colnames(tot)

tot <- rbind(tot, droits)
#setcolorder(tot, c(colnames(TF)))



```


```{r xtable, results="asis", echo=FALSE}

library(xtable)


#g <- 10

TF[TF==0,]  <- NA
#tot[tot==0] <- NA

for (g in unique(TF$Grp)) {
    
    
#for (g in 1:15) {

    tab1 <- xtable(TF[Grp == g, -1][, 
                                    TradeDate:= as.character(
                                        strftime(TradeDate, 
                                                 format= "%d-%m-%Y"))],
                   NA.string= '',
                   digits= c( 0, 0, 0, 0, 0, 0, 0, 3, 0, 4, 0, 0, 0, 0, 0),
                   align=  c("l||cc|crllr|cr|lc||rr|r||"),
                   label="coucou")
    
tab2 <- xtable(tot[Grp== g, -1],
               NA.string= '',
               digits= c(0,0,0,0),
               align= c("l||rr|r||"))


# tab <-list(tab1, tab2)

options(xtable.comment = FALSE, 
        xtable.caption.width="p{30}",
        xtable.include.rownames= FALSE, 
        xtable.scalebox= 0.8,
        xtable.format.args = list(big.mark = "'"))



print(tab1, type="latex",
           hline.after= c(-1, 0, TF[Grp == g,][grepl("Interacti", ClientId), which= TRUE]))

print(tab2, type="latex", include.colnames = TRUE, table.placement= "!b")

print(xtable(matrix(paste0("Page: ", g),1,1)), 
      include.colnames = FALSE,
      table.placement= "b")
}

print(xtable(TF[, lapply(.SD, sum, na.rm= TRUE), 
                .SDcols= c("SoumisSuisse", "SoumisEtr","NonSoumis")]),
      table.placement = "!b")
          

```

